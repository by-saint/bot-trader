import React, { useState, useEffect, useCallback } from 'react';
import { 
  ShieldCheck, TrendingUp, Target, AlertCircle, RefreshCw, 
  Timer, ExternalLink, Wallet, Coins, ArrowUpRight, 
  Zap, BarChart3, Scale, Info
} from 'lucide-react';

// =============================================================================
// PARTE 1: O CÉREBRO DO ROBÔ (LOGIC ENGINE)
// Aqui fica toda a inteligência, cálculos e conexão com as APIs.
// =============================================================================

const MB_WHITELIST = [
  'BTC', 'ETH', 'SOL', 'XRP', 'ADA', 'DOT', 'LINK', 'AVAX', 'MATIC', 'LTC', 
  'BCH', 'DOGE', 'SHIB', 'NEAR', 'ALGO', 'ATOM', 'UNI', 'AAVE', 'SAND',
  'MANA', 'GRT', 'CHZ', 'AXS', 'RENDER', 'FETCH', 'PEPE', 'STX', 'TIA', 'BONK', 'FLOKI'
];

const CONFIG = {
  FEE_ESTIMATE: 0.014,   // 1.4% (Taxas compra + venda do Mercado Bitcoin)
  TARGET_MOVE: 1.045,    // Alvo de 4.5% para garantir lucro líquido
  STOP_LOSS: 0.98,       // Proteção de 2%
  MIN_SCORE: 75,         // Confiança mínima para exibir o sinal
  REFRESH_TIME: 60       // Intervalo de atualização (segundos)
};

// Hook Customizado que funciona como o "Motor" do Robô
const useTradingEngine = () => {
  const [signals, setSignals] = useState([]);
  const [loading, setLoading] = useState(true);
  const [usdtBrl, setUsdtBrl] = useState(0);
  const [lastCheck, setLastCheck] = useState(null);

  const calculateTechnicalScore = (k15, k1h) => {
    const c15 = k15.map(k => parseFloat(k[4]));
    const c1h = k1h.map(k => parseFloat(k[4]));
    const price = c15[c15.length - 1];

    // Análise Macro (1h) e Micro (15m)
    const sma200h = c1h.slice(-200).reduce((a, b) => a + b, 0) / 200;
    const ema50m = c15.slice(-50).reduce((a, b) => a + b, 0) / 50;

    // RSI 14
    let gains = 0, losses = 0;
    for (let i = c15.length - 14; i < c15.length; i++) {
      const diff = c15[i] - c15[i - 1];
      if (diff >= 0) gains += diff; else losses -= diff;
    }
    const rsi = 100 - (100 / (1 + ((gains / 14) / (losses / 14 || 1))));

    // Score final baseado em pesos
    let score = 0;
    if (price > sma200h) score += 30; // Tendência Macro Alta
    if (price > ema50m) score += 20;  // Tendência Micro Alta
    if (rsi < 42) score += 25;        // Preço em recuo (desconto)
    
    const volCurrent = parseFloat(k15[k15.length - 1][5]);
    const volAvg = k15.slice(-20).reduce((a, b) => a + parseFloat(b[5]), 0) / 20;
    if (volCurrent > volAvg * 1.3) score += 25; // Volume acima da média

    return { price, rsi, score };
  };

  const runScan = useCallback(async () => {
    try {
      // Pega cotação do Dólar
      const dRes = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=USDTBRL');
      const dData = await dRes.json();
      const dollar = parseFloat(dData.price);
      setUsdtBrl(dollar);

      // Pega dados de volume
      const tRes = await fetch('https://api.binance.com/api/v3/ticker/24hr');
      const tData = await tRes.json();

      const results = [];
      for (const coin of MB_WHITELIST) {
        const pair = `${coin}USDT`;
        const ticker = tData.find(t => t.symbol === pair);
        if (!ticker || parseFloat(ticker.quoteVolume) < 3000000) continue;

        const [k15, k1h] = await Promise.all([
          fetch(`https://api.binance.com/api/v3/klines?symbol=${pair}&interval=15m&limit=200`).then(r => r.json()),
          fetch(`https://api.binance.com/api/v3/klines?symbol=${pair}&interval=1h&limit=200`).then(r => r.json())
        ]);

        const analysis = calculateTechnicalScore(k15, k1h);

        if (analysis.score >= CONFIG.MIN_SCORE) {
          const brlPrice = analysis.price * dollar;
          results.push({
            coin,
            score: analysis.score,
            priceBRL: brlPrice,
            targetBRL: brlPrice * CONFIG.TARGET_MOVE,
            stopBRL: brlPrice * CONFIG.STOP_LOSS,
            rsi: analysis.rsi.toFixed(1),
            netProfit: ((CONFIG.TARGET_MOVE - 1 - CONFIG.FEE_ESTIMATE) * 100).toFixed(2)
          });
        }
      }
      setSignals(results.sort((a, b) => b.score - a.score));
      setLastCheck(new Date().toLocaleTimeString());
      setLoading(false);
    } catch (err) {
      console.error("Erro no motor:", err);
    }
  }, []);

  return { signals, loading, usdtBrl, lastCheck, runScan };
};

// =============================================================================
// PARTE 2: O DESIGN DO SITE (UI COMPONENTS)
// Toda a parte visual, cores e componentes responsivos.
// =============================================================================

const App = () => {
  const { signals, loading, usdtBrl, lastCheck, runScan } = useTradingEngine();
  const [timer, setTimer] = useState(CONFIG.REFRESH_RATE);

  useEffect(() => {
    runScan();
    const clock = setInterval(() => {
      setTimer(t => {
        if (t <= 1) { runScan(); return CONFIG.REFRESH_RATE; }
        return t - 1;
      });
    }, 1000);
    return () => clearInterval(clock);
  }, [runScan]);

  const formatBRL = (val) => {
    if (val < 0.01) return "R$ " + val.toFixed(8).replace('.', ',');
    return val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: val < 1 ? 4 : 2 });
  };

  return (
    <div className="min-h-screen bg-[#0a0a0b] text-slate-200 font-sans p-4 md:p-8">
      {/* Header Central */}
      <div className="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center bg-[#141417] border border-white/5 p-6 rounded-[32px] mb-8 shadow-2xl gap-6">
        <div className="flex items-center gap-4">
          <div className="bg-indigo-600 p-3 rounded-2xl text-white shadow-lg shadow-indigo-500/20">
            <Zap size={28} fill="currentColor" />
          </div>
          <div>
            <h1 className="text-2xl font-black text-white tracking-tighter uppercase italic">MB ULTRA <span className="text-indigo-500">SNIPER</span></h1>
            <p className="text-[10px] text-slate-500 font-bold uppercase tracking-widest">USDT/BRL: R$ {usdtBrl.toFixed(2)}</p>
          </div>
        </div>

        <div className="flex items-center gap-8">
          <div className="text-right border-r border-white/10 pr-8 hidden sm:block">
            <p className="text-[10px] text-slate-500 font-bold uppercase">Status do Sistema</p>
            <p className="text-xs font-bold text-emerald-400 flex items-center gap-1 justify-end"><ShieldCheck size={14}/> Análise Ativa</p>
          </div>
          <div className="flex items-center gap-4">
            <div className="text-right">
              <p className="text-[10px] text-slate-500 font-bold uppercase">Atualizando</p>
              <p className="text-xl font-mono font-bold text-indigo-500 flex items-center gap-2"><Timer size={18}/> {timer}s</p>
            </div>
            <button onClick={runScan} className="p-3 bg-white/5 hover:bg-white/10 rounded-2xl border border-white/10 transition-all active:scale-90">
              <RefreshCw size={20} />
            </button>
          </div>
        </div>
      </div>

      <main className="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
        {/* Painel de Sinais */}
        <div className="lg:col-span-8 space-y-6">
          <div className="flex justify-between items-center px-2">
            <h2 className="text-sm font-bold text-slate-400 flex items-center gap-2"><BarChart3 size={18}/> OPORTUNIDADES DETECTADAS</h2>
            <span className="text-[10px] text-slate-600 uppercase font-bold tracking-widest">Última checagem: {lastCheck}</span>
          </div>

          {loading ? (
            <div className="bg-[#141417] p-32 rounded-[48px] border border-white/5 text-center">
              <RefreshCw size={48} className="animate-spin mx-auto text-indigo-500 mb-6" />
              <p className="text-slate-500 font-bold uppercase tracking-[0.3em] text-[10px]">Iniciando Algoritmos de Precisão...</p>
            </div>
          ) : signals.length === 0 ? (
            <div className="bg-[#141417] p-24 rounded-[48px] border border-dashed border-white/10 text-center">
              <AlertCircle size={50} className="mx-auto text-slate-800 mb-4" />
              <h3 className="text-lg font-bold">Aguardando Confirmação</h3>
              <p className="text-slate-500 text-sm mt-2 max-w-xs mx-auto">Nenhuma moeda atingiu o Score de segurança de {CONFIG.MIN_SCORE} neste minuto.</p>
            </div>
          ) : (
            <div className="grid gap-6">
              {signals.map((sig, i) => (
                <div key={i} className="bg-[#141417] border border-white/5 rounded-[40px] p-8 hover:border-indigo-500/30 transition-all shadow-2xl relative group">
                  <div className="absolute top-8 right-8 text-right">
                    <p className="text-[9px] text-slate-500 font-bold uppercase mb-1">Score Confiança</p>
                    <div className="bg-indigo-600 text-white font-black px-4 py-1 rounded-xl text-xl">{sig.score}</div>
                  </div>

                  <div className="flex items-center gap-5 mb-8">
                    <div className="w-14 h-14 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-2xl flex items-center justify-center text-white text-2xl font-black">
                      {sig.coin[0]}
                    </div>
                    <div>
                      <h3 className="text-3xl font-black text-white tracking-tighter">{sig.coin}</h3>
                      <p className="text-[11px] text-emerald-400 font-bold uppercase tracking-widest mt-1">Lucro Líquido: +{sig.netProfit}%</p>
                    </div>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <CardPrice label="Preço de Entrada" val={formatBRL(sig.priceBRL)} color="text-white" />
                    <CardPrice label="Alvo de Venda" val={formatBRL(sig.targetBRL)} color="text-indigo-400" />
                    <CardPrice label="Stop Loss" val={formatBRL(sig.stopBRL)} color="text-red-500" />
                  </div>

                  <div className="flex flex-col md:flex-row justify-between items-center gap-4 pt-6 border-t border-white/5">
                    <div className="flex gap-6 text-[10px] text-slate-500 font-bold uppercase">
                      <span>RSI: <b className="text-slate-300">{sig.rsi}</b></span>
                      <span>Analise: <b className="text-slate-300">Multitemporal</b></span>
                    </div>
                    <a 
                      href={`https://www.mercadobitcoin.com.br/negociacoes/${sig.coin.toLowerCase()}`}
                      target="_blank" rel="noreferrer"
                      className="w-full md:w-auto bg-white text-black font-black text-xs px-10 py-4 rounded-2xl hover:bg-indigo-500 hover:text-white transition-all flex items-center justify-center gap-2 uppercase tracking-widest"
                    >
                      Operar no MB <ExternalLink size={14} />
                    </a>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>

        {/* Sidebar */}
        <div className="lg:col-span-4 space-y-6">
          <div className="bg-[#141417] p-8 rounded-[40px] border border-white/5">
            <h3 className="text-white font-bold mb-6 flex items-center gap-2 uppercase text-sm"><Scale size={18} className="text-indigo-500" /> Inteligência Ultra</h3>
            <div className="space-y-6">
              <Step title="Análise em 2 Tempos" desc="Varredura simultânea nos gráficos de 15 minutos e 1 hora para maior precisão." />
              <Step title="Taxas Inclusas" desc="O alvo de lucro já desconta as taxas de compra e venda do Mercado Bitcoin." />
              <Step title="Volume Real" desc="Detecta picos de negociação que indicam entrada de grandes investidores." />
            </div>
          </div>
          <div className="bg-indigo-600/10 border border-indigo-500/20 p-6 rounded-[32px]">
            <h4 className="text-xs font-bold text-indigo-400 flex items-center gap-2 mb-2 uppercase tracking-tighter"><Info size={14}/> Dica de Trader</h4>
            <p className="text-[11px] text-slate-400 leading-relaxed italic">"O segredo é a paciência. Quando o robô não mostra nada, ele está salvando o seu capital de uma entrada ruim."</p>
          </div>
        </div>
      </main>
    </div>
  );
};

const CardPrice = ({ label, val, color }) => (
  <div className="bg-black/20 p-5 rounded-2xl border border-white/5">
    <p className="text-[10px] text-slate-500 font-bold uppercase mb-2 tracking-widest">{label}</p>
    <p className={`text-xl font-mono font-bold ${color}`}>{val}</p>
  </div>
);

const Step = ({ title, desc }) => (
  <div className="relative pl-6 border-l border-indigo-500/30">
    <div className="absolute -left-[4.5px] top-0 w-2 h-2 bg-indigo-500 rounded-full"></div>
    <h4 className="text-xs font-bold text-white uppercase">{title}</h4>
    <p className="text-[10px] text-slate-500 mt-2 leading-relaxed">{desc}</p>
  </div>
);

export default App;
